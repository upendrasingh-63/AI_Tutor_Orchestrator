<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor Orchestrator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js to render Markdown from the API -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* A little custom styling for the chat bubbles and scrollbar */
        .chat-bubble-user {
            background-color: #dbeafe;
            /* Tailwind blue-100 */
        }

        .chat-bubble-ai {
            background-color: #f3f4f6;
            /* Tailwind gray-100 */
        }

        .prose h1,
        .prose h2,
        .prose h3 {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        .prose p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        #chat-window::-webkit-scrollbar {
            width: 8px;
        }

        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="bg-gray-50 flex flex-col h-screen font-sans">

    <header class="bg-white border-b border-gray-200 p-4 shadow-sm">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-2xl font-bold text-gray-800">Autonomous AI Tutor</h1>
            <p class="text-sm text-gray-500">Powered by a Multi-Tool Orchestrator</p>
        </div>
    </header>

    <main id="chat-window" class="flex-1 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto space-y-4">
            <!-- Initial AI Welcome Message -->
            <div class="flex items-start gap-3">
                <div
                    class="bg-gray-700 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold text-sm flex-shrink-0">
                    AI</div>
                <div class="chat-bubble-ai p-4 rounded-lg prose prose-sm max-w-none text-gray-800 shadow-sm">
                    <p>Hello! I'm your AI Tutor. How can I help you study today? You can ask me to explain a concept,
                        create notes, or even make flashcards.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 p-4">
        <div class="max-w-4xl mx-auto">
            <form id="chat-form" class="flex items-center gap-3">
                <input type="text" id="message-input" placeholder="Ask me anything..."
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                    autocomplete="off">
                <button type="submit" id="send-button"
                    class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 transition">
                    Send
                </button>
            </form>
        </div>
    </footer>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // --- Main function to handle form submission ---
        chatForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // Display user's message
            appendMessage(message, 'user');
            messageInput.value = '';

            // Show loading indicator and disable form
            showLoadingIndicator();
            sendButton.disabled = true;

            try {
                // --- API Call to your FastAPI backend ---
                const response = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: "student123", // Using a static user_id for this demo
                        message: message
                    })
                });

                removeLoadingIndicator();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'An API error occurred');
                }

                const data = await response.json();

                // Display the AI's formatted chat response
                appendMessage(data.chat_response, 'ai', data.tool_used, data.tool_data);

            } catch (error) {
                console.error('Error:', error);
                removeLoadingIndicator();
                appendMessage(`Sorry, I encountered an error: ${error.message}`, 'ai-error');
            } finally {
                sendButton.disabled = false;
            }
        });

        // --- Helper function to display messages in the chat window ---
        function appendMessage(text, role, toolsUsed = [], toolData = []) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'max-w-4xl mx-auto space-y-4';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex items-start gap-3';

            const avatar = document.createElement('div');
            avatar.className = `rounded-full h-8 w-8 flex items-center justify-center font-bold text-sm flex-shrink-0 ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-700 text-white'}`;
            avatar.textContent = role === 'user' ? 'You' : 'AI';

            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-lg shadow-sm ${role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;

            const content = document.createElement('div');
            content.className = 'prose prose-sm max-w-none text-gray-800';

            // Use marked.js to render the Markdown from the API response
            content.innerHTML = marked.parse(text);

            bubble.appendChild(content);

            // --- SPECIAL UI RENDERING FOR TOOLS ---
            // If flashcards were used, render them in a special way
            if (role === 'ai' && toolsUsed.includes('Flashcards')) {
                const flashcardData = toolData.find(d => d._tool_name_ === 'Flashcards');
                if (flashcardData && flashcardData.flashcards) {
                    const flashcardsContainer = createFlashcardsUI(flashcardData.flashcards);
                    bubble.appendChild(flashcardsContainer);
                }
            }

            if (role === 'user') {
                messageWrapper.append(bubble, avatar);
                messageWrapper.classList.add('justify-end');
            } else {
                messageWrapper.append(avatar, bubble);
            }

            messageContainer.appendChild(messageWrapper);
            chatWindow.appendChild(messageContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the latest message
        }

        function createFlashcardsUI(flashcards) {
            const container = document.createElement('div');
            container.className = 'mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3';

            flashcards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'bg-white border border-gray-200 rounded-lg p-3 shadow-md';
                const question = document.createElement('p');
                question.className = 'font-semibold text-gray-700';
                question.textContent = `Q: ${card.question}`;
                const answer = document.createElement('p');
                answer.className = 'text-gray-600 mt-1';
                answer.textContent = `A: ${card.answer}`;
                cardEl.append(question, answer);
                container.appendChild(cardEl);
            });
            return container;
        }

        function showLoadingIndicator() {
            const loadingContainer = document.createElement('div');
            loadingContainer.id = 'loading-indicator';
            loadingContainer.className = 'max-w-4xl mx-auto space-y-4';

            loadingContainer.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="bg-gray-700 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold text-sm flex-shrink-0">AI</div>
                <div class="chat-bubble-ai p-4 rounded-lg shadow-sm flex items-center space-x-2">
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                </div>
            </div>`;
            chatWindow.appendChild(loadingContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    </script>

</body>

</html>